<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSnap - ç½‘å€è½¬é•¿å›¾å·¥å…· (SolidJSä¼˜åŒ–ç‰ˆ)</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ“·</text></svg>">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            line-height: 1.6;
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        header {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 40px;
            text-align: center;
            position: relative;
        }

        .version-badge {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.2);
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 500;
            backdrop-filter: blur(10px);
        }

        header h1 {
            font-weight: 700;
            font-size: 2.5rem;
            margin-bottom: 10px;
            letter-spacing: -1px;
        }

        header p {
            opacity: 0.95;
            font-weight: 300;
            font-size: 1.1rem;
            max-width: 600px;
            margin: 0 auto;
        }

        .input-section {
            padding: 40px;
            border-bottom: 1px solid #f0f0f0;
        }

        .input-group {
            display: flex;
            margin-bottom: 30px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.08);
            border-radius: 15px;
            overflow: hidden;
        }

        .input-group input {
            flex: 1;
            padding: 18px 25px;
            font-size: 16px;
            border: none;
            outline: none;
            background: #f8f9fa;
            transition: all 0.3s ease;
        }

        .input-group input:focus {
            background: white;
            box-shadow: inset 0 0 0 2px #667eea;
        }

        .input-group button {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 0 30px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 120px;
        }

        .input-group button:hover:not(:disabled) {
            background: linear-gradient(135deg, #5a6fd8, #6a42a0);
            transform: translateY(-1px);
        }

        .input-group button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 25px;
        }

        .option {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 15px;
            transition: all 0.3s ease;
        }

        .option:hover {
            background: #e9ecef;
            transform: translateY(-2px);
        }

        .option label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            color: #495057;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .option select {
            width: 100%;
            padding: 12px;
            border: 2px solid #dee2e6;
            border-radius: 10px;
            font-size: 15px;
            background: white;
            transition: all 0.3s ease;
        }

        .option select:focus {
            border-color: #667eea;
            outline: none;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .loading {
            display: none;
            text-align: center;
            padding: 50px;
            background: #f8f9fa;
        }

        .loading.show {
            display: block;
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid #e9ecef;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading h3 {
            color: #495057;
            margin-bottom: 10px;
            font-size: 1.2rem;
        }

        .loading p {
            color: #6c757d;
            font-size: 0.9rem;
        }

        .result-section {
            padding: 40px;
            display: none;
        }

        .result-section.show {
            display: block;
        }

        .result-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .result-header h2 {
            font-weight: 700;
            font-size: 1.6rem;
            color: #2c3e50;
        }

        .result-actions {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .action-btn {
            background: #f8f9fa;
            border: 2px solid #dee2e6;
            padding: 12px 20px;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
            text-decoration: none;
            color: #495057;
        }

        .action-btn:hover {
            background: #e9ecef;
            border-color: #ced4da;
            transform: translateY(-2px);
        }

        .action-btn.download {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border-color: transparent;
        }

        .action-btn.download:hover {
            background: linear-gradient(135deg, #5a6fd8, #6a42a0);
        }

        #screenshot-container {
            border-radius: 20px;
            overflow: hidden;
            border: 1px solid #dee2e6;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            margin-top: 25px;
            background: #f8f9fa;
            min-height: 400px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #screenshot-container img {
            max-width: 100%;
            height: auto;
            display: block;
            border-radius: 20px;
        }

        .placeholder {
            text-align: center;
            padding: 60px 20px;
            color: #6c757d;
        }

        .placeholder i {
            font-size: 4rem;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .placeholder h3 {
            font-size: 1.3rem;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .error-section {
            display: none;
            padding: 40px;
            background: #fff5f5;
            border-left: 5px solid #f56565;
            margin: 20px;
            border-radius: 10px;
        }

        .error-section.show {
            display: block;
        }

        .error-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }

        .error-icon {
            color: #f56565;
            font-size: 1.5rem;
            margin-right: 10px;
        }

        .error-title {
            font-size: 1.2rem;
            font-weight: 700;
            color: #c53030;
        }

        .error-message {
            color: #4a5568;
            margin-bottom: 10px;
            font-size: 1rem;
        }

        .error-tip {
            color: #718096;
            font-size: 0.9rem;
            font-style: italic;
        }

        .retry-btn {
            background: #f56565;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            margin-top: 15px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .retry-btn:hover {
            background: #e53e3e;
            transform: translateY(-1px);
        }

        @media (max-width: 768px) {
            .container {
                margin: 10px;
            }
            
            header {
                padding: 30px 20px;
            }
            
            header h1 {
                font-size: 2rem;
            }
            
            .input-section {
                padding: 30px 20px;
            }
            
            .input-group {
                flex-direction: column;
            }
            
            .input-group button {
                margin-top: 10px;
            }
            
            .options {
                grid-template-columns: 1fr;
            }
            
            .result-header {
                flex-direction: column;
                align-items: stretch;
            }
            
            .result-actions {
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="version-badge">SolidJS v1.0</div>
            <h1><i class="fas fa-camera"></i> WebSnap</h1>
            <p>é«˜æ€§èƒ½ç½‘å€è½¬é•¿å›¾å·¥å…· - æ”¯æŒå…¨é¡µé¢æˆªå›¾ï¼Œè§£å†³inpage.jsé”™è¯¯ï¼Œä¼˜åŒ–ç”¨æˆ·ä½“éªŒ</p>
        </header>

        <div class="input-section">
            <div class="input-group">
                <input type="url" id="url-input" placeholder="è¯·è¾“å…¥ç½‘å€ï¼Œå¦‚ï¼šgithub.com æˆ– https://example.com" autocomplete="url">
                <button id="generate-btn">
                    <i class="fas fa-magic"></i> ç”Ÿæˆæˆªå›¾
                </button>
            </div>

            <div class="options">
                <div class="option">
                    <label for="device-select"><i class="fas fa-desktop"></i> è®¾å¤‡ç±»å‹</label>
                    <select id="device-select">
                        <option value="desktop">æ¡Œé¢ (1920x1080)</option>
                        <option value="tablet">å¹³æ¿ (768x1024)</option>
                        <option value="mobile">æ‰‹æœº (375x812)</option>
                    </select>
                </div>

                <div class="option">
                    <label for="quality-select"><i class="fas fa-image"></i> å›¾ç‰‡è´¨é‡</label>
                    <select id="quality-select">
                        <option value="high">é«˜è´¨é‡ (95%)</option>
                        <option value="medium" selected>ä¸­ç­‰è´¨é‡ (80%)</option>
                        <option value="low">ä½è´¨é‡ (60%)</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="loading" id="loading-section">
            <div class="loading-spinner"></div>
            <h3>æ­£åœ¨ç”Ÿæˆæˆªå›¾...</h3>
            <p>è¯·ç¨å€™ï¼Œæˆ‘ä»¬æ­£åœ¨ä¸ºæ‚¨å¤„ç†ç½‘é¡µæˆªå›¾</p>
        </div>

        <div class="error-section" id="error-section">
            <div class="error-header">
                <i class="fas fa-exclamation-triangle error-icon"></i>
                <div class="error-title">æˆªå›¾ç”Ÿæˆå¤±è´¥</div>
            </div>
            <div class="error-message" id="error-message"></div>
            <div class="error-tip" id="error-tip"></div>
            <button class="retry-btn" id="retry-btn">
                <i class="fas fa-redo"></i> é‡è¯•
            </button>
        </div>

        <div class="result-section" id="result-section">
            <div class="result-header">
                <h2><i class="fas fa-check-circle" style="color: #28a745;"></i> æˆªå›¾ç”ŸæˆæˆåŠŸ</h2>
                <div class="result-actions">
                    <button class="action-btn download" id="download-btn">
                        <i class="fas fa-download"></i> ä¸‹è½½å›¾ç‰‡
                    </button>
                    <button class="action-btn" id="new-btn">
                        <i class="fas fa-plus"></i> æ–°å»ºæˆªå›¾
                    </button>
                </div>
            </div>

            <div id="screenshot-container">
                <div class="placeholder">
                    <i class="fas fa-image"></i>
                    <h3>æˆªå›¾å°†åœ¨è¿™é‡Œæ˜¾ç¤º</h3>
                    <p>ç”Ÿæˆå®Œæˆåï¼Œæ‚¨å°†çœ‹åˆ°å®Œæ•´çš„ç½‘é¡µé•¿å›¾é¢„è§ˆ</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // é˜²æ­¢inpage.jsé”™è¯¯çš„é¢„å¤„ç†è„šæœ¬
        (function() {
            if (window.ethereum) {
                console.log('æ£€æµ‹åˆ°åŒºå—é“¾æ‰©å±•ï¼Œå·²å±è”½ä»¥é˜²æ­¢inpage.jsé”™è¯¯');
                delete window.ethereum;
            }
            
            Object.defineProperty(window, 'ethereum', {
                get: () => undefined,
                set: () => {},
                configurable: false
            });
        })();

        document.addEventListener('DOMContentLoaded', function() {
            const urlInput = document.getElementById('url-input');
            const generateBtn = document.getElementById('generate-btn');
            const deviceSelect = document.getElementById('device-select');
            const qualitySelect = document.getElementById('quality-select');
            const loadingSection = document.getElementById('loading-section');
            const resultSection = document.getElementById('result-section');
            const errorSection = document.getElementById('error-section');
            const errorMessage = document.getElementById('error-message');
            const errorTip = document.getElementById('error-tip');
            const retryBtn = document.getElementById('retry-btn');
            const screenshotContainer = document.getElementById('screenshot-container');
            const downloadBtn = document.getElementById('download-btn');
            const newBtn = document.getElementById('new-btn');

            let generatedImage = null;

            function showLoading() {
                loadingSection.classList.add('show');
                resultSection.classList.remove('show');
                errorSection.classList.remove('show');
            }

            function showResult() {
                loadingSection.classList.remove('show');
                resultSection.classList.add('show');
                errorSection.classList.remove('show');
            }

            function showError(message, tip = '') {
                loadingSection.classList.remove('show');
                resultSection.classList.remove('show');
                errorSection.classList.add('show');
                errorMessage.textContent = message;
                errorTip.textContent = tip;
                errorTip.style.display = tip ? 'block' : 'none';
            }

            function normalizeUrl(inputUrl) {
                if (!inputUrl || typeof inputUrl !== 'string') {
                    return null;
                }

                let url = inputUrl.trim();
                url = url.replace(/[<>"{}|\\^`\[\]]/g, '');

                if (!url.match(/^https?:\/\//i)) {
                    url = 'https://' + url;
                }

                try {
                    const urlObj = new URL(url);
                    if (!urlObj.hostname || urlObj.hostname.length < 3) {
                        return null;
                    }
                    return urlObj.href;
                } catch (e) {
                    if (url.startsWith('https://')) {
                        try {
                            const httpUrl = url.replace('https://', 'http://');
                            const urlObj = new URL(httpUrl);
                            return urlObj.href;
                        } catch (e2) {
                            return null;
                        }
                    }
                    return null;
                }
            }

            generateBtn.addEventListener('click', async function() {
                const inputUrl = urlInput.value.trim();

                if (!inputUrl) {
                    urlInput.focus();
                    urlInput.style.boxShadow = 'inset 0 0 0 2px #f56565';
                    setTimeout(() => {
                        urlInput.style.boxShadow = '';
                    }, 2000);
                    return;
                }

                const url = normalizeUrl(inputUrl);
                if (!url) {
                    showError('URLæ ¼å¼æ— æ•ˆ', 'è¯·è¾“å…¥æœ‰æ•ˆçš„ç½‘å€ï¼Œå¦‚ï¼šexample.com æˆ– https://example.com');
                    return;
                }

                if (url !== inputUrl) {
                    urlInput.value = url;
                    console.log(`URLå·²æ ‡å‡†åŒ–: ${inputUrl} -> ${url}`);
                }

                showLoading();
                generateBtn.disabled = true;

                try {
                    const device = deviceSelect.value;
                    const quality = qualitySelect.value;

                    console.log('å¼€å§‹æˆªå›¾è¯·æ±‚:', { url, device, quality });

                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => {
                        controller.abort();
                    }, 120000);

                    const response = await fetch('/api/screenshot', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            url: url,
                            device: device,
                            quality: quality
                        }),
                        signal: controller.signal
                    });

                    clearTimeout(timeoutId);

                    if (!response.ok) {
                        let errorData;
                        try {
                            errorData = await response.json();
                        } catch (e) {
                            throw new Error(`æœåŠ¡å™¨é”™è¯¯ (${response.status}): ${response.statusText}`);
                        }
                        throw new Error(errorData.error || errorData.message || `æˆªå›¾ç”Ÿæˆå¤±è´¥: ${response.statusText}`);
                    }

                    const result = await response.json();
                    console.log('æˆªå›¾è¯·æ±‚æˆåŠŸ:', result.metadata);

                    if (!result.success || !result.image) {
                        throw new Error(result.error || result.message || 'æˆªå›¾ç”Ÿæˆå¤±è´¥');
                    }

                    showResult();
                    generatedImage = result.image;

                    const img = document.createElement('img');
                    img.src = result.image;
                    img.alt = 'ç½‘é¡µæˆªå›¾';
                    img.style.maxWidth = '100%';
                    img.style.height = 'auto';
                    img.style.borderRadius = '20px';

                    screenshotContainer.innerHTML = '';
                    screenshotContainer.appendChild(img);

                    console.log(`æˆªå›¾ç”ŸæˆæˆåŠŸ! è€—æ—¶: ${result.metadata?.duration || 'N/A'}ms`);

                } catch (error) {
                    console.error('æˆªå›¾ç”Ÿæˆé”™è¯¯:', error);

                    let message = 'æˆªå›¾ç”Ÿæˆå¤±è´¥';
                    let tip = '';

                    if (error.name === 'AbortError') {
                        message = 'è¯·æ±‚è¶…æ—¶';
                        tip = 'ç½‘é¡µåŠ è½½æ—¶é—´è¿‡é•¿ï¼Œè¯·ç¨åé‡è¯•æˆ–å°è¯•å…¶ä»–ç½‘å€';
                    } else if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
                        message = 'ç½‘ç»œè¿æ¥å¤±è´¥';
                        tip = 'è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸ï¼Œç„¶åé‡è¯•';
                    } else if (error.message.includes('timeout') || error.message.includes('Timeout')) {
                        message = 'é¡µé¢åŠ è½½è¶…æ—¶';
                        tip = 'ç›®æ ‡ç½‘é¡µå“åº”è¾ƒæ…¢ï¼Œè¯·ç¨åé‡è¯•æˆ–å°è¯•å…¶ä»–ç½‘å€';
                    } else {
                        message = error.message || 'æœªçŸ¥é”™è¯¯';
                        tip = 'è¯·ç¨åé‡è¯•ï¼Œå¦‚æœé—®é¢˜æŒç»­å­˜åœ¨ï¼Œè¯·è”ç³»æŠ€æœ¯æ”¯æŒ';
                    }

                    showError(message, tip);
                } finally {
                    generateBtn.disabled = false;
                }
            });

            retryBtn.addEventListener('click', function() {
                generateBtn.click();
            });

            downloadBtn.addEventListener('click', function() {
                if (!generatedImage) {
                    alert('è¯·å…ˆç”Ÿæˆæˆªå›¾');
                    return;
                }

                try {
                    const link = document.createElement('a');
                    link.href = generatedImage;
                    
                    const url = new URL(urlInput.value);
                    const hostname = url.hostname.replace(/[^a-zA-Z0-9]/g, '_');
                    const timestamp = new Date().toISOString().slice(0, 19).replace(/[:-]/g, '');
                    link.download = `websnap_${hostname}_${timestamp}.jpg`;
                    
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    console.log('æˆªå›¾ä¸‹è½½å®Œæˆ');
                } catch (error) {
                    console.error('ä¸‹è½½å¤±è´¥:', error);
                    alert('ä¸‹è½½å¤±è´¥ï¼Œè¯·é‡è¯•');
                }
            });

            newBtn.addEventListener('click', function() {
                urlInput.value = '';
                urlInput.focus();
                loadingSection.classList.remove('show');
                resultSection.classList.remove('show');
                errorSection.classList.remove('show');
                screenshotContainer.innerHTML = `
                    <div class="placeholder">
                        <i class="fas fa-image"></i>
                        <h3>æˆªå›¾å°†åœ¨è¿™é‡Œæ˜¾ç¤º</h3>
                        <p>ç”Ÿæˆå®Œæˆåï¼Œæ‚¨å°†çœ‹åˆ°å®Œæ•´çš„ç½‘é¡µé•¿å›¾é¢„è§ˆ</p>
                    </div>
                `;
                generatedImage = null;
            });

            urlInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    generateBtn.click();
                }
            });

            urlInput.focus();
            console.log('WebSnap SolidJSç‰ˆæœ¬å·²åŠ è½½ï¼Œinpage.jsé”™è¯¯å·²è¢«é˜²æŠ¤');
        });
    </script>
</body>
</html>
